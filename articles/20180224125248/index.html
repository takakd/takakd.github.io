<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"  lang="ja" >

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  
  <title>HTML FormでS3にPOST | taka👨🏻‍💻</title>
  
  
  
  <link href="https://takakd.github.io/index.xml" rel="alternate" type="application/rss+xml" title="taka👨🏻‍💻" />
  
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
    integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
  
  <link rel='stylesheet' href='/assets/style.min.4be1aa33a3190cfbe1648f3bc1749794b2555c99f1029a279753160ae6e0d19f.css'>
  
  
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="shortcut icon" href="/favicon.ico">
  
  
  
  
  
  
  
  <meta name="description"
    content="AWSのリファレンスを参考に、FormでS3バケットへのPOSTを試してみました。 準備 FormでS3にPOSTするためには、各フィールドに送信するファイルに合わせ、POST Policy、Signature、アクセスID、その他ファイル" />
</head>

<body class="d-flex flex-column vh-100">
  <section class="nav-Section m-0 p-0">
  <nav class="nav d-flex px-4 px-lg-5 align-items-center justify-content-between">
    <div class="my-3 my-lg-4">
      <a class="p-0 text-decoration-none" href="https://takakd.github.io">
        <h1 class="cs-title p-0 m-0">taka👨🏻‍💻</h1>
      </a>
    </div>
    <nav><a href="/about/" class="cs-menu-link text-decoration-none">
        About
      </a></nav>
  </nav>
</section>
  <section class="sn-Section m-0 p-0">
    <div class="px-4 px-lg-5 pt-5 pb-5">
      <h1 class="cs-title">HTML FormでS3にPOST</h1>
      <h2 class="cs-subtitle pt-2">2018-02-24</h2>
      <div class="m-0 p-0">
        
          <a class="cs-tags" href="/tags/aws">#AWS</a>
        
      </div>
      
      <div class="content sn-Content mt-5">
        <p><a href="https://docs.aws.amazon.com/AmazonS3/latest/API/sigv4-HTTPPOSTForms.html%22">AWSのリファレンス</a>を参考に、FormでS3バケットへのPOSTを試してみました。</p>
<h2 id="準備">準備</h2>
<p>FormでS3にPOSTするためには、各フィールドに送信するファイルに合わせ、POST Policy、Signature、アクセスID、その他ファイルに関する情報を設定する必要があります。<br>
（POST Policy：POSTする時につける設定情報、Signatureはそれをシークレットキーでhashしたもの）</p>
<h3 id="バケットポリシー">バケットポリシー</h3>
<p>フィールドにアクセスIDを設定しますが、このアクセスIDに対応するIAMユーザーは、POST先のバケットに対する操作権限が必要です。<br>
基本的なAWSのIAMユーザーの考えですね。</p>
<p>次のようにバケットポリシーを設定します。</p>
<pre><code class="language-json">{
  &quot;Version&quot;: &quot;2012-10-17&quot;,
  &quot;Statement&quot;: [
    {
      &quot;Effect&quot;: &quot;Allow&quot;,
      &quot;Principal&quot;: {
      &quot;AWS&quot;: &quot;arn:aws:iam::&lt;12桁の数字&gt;:user/&lt;IAMユーザー名&gt;&quot;
      },
      &quot;Action&quot;: &quot;s3:*&quot;,
      &quot;Resource&quot;: [
        &quot;arn:aws:s3:::&lt;バケット名&gt;/*&quot;
      ]
    }
  ]
}
</code></pre>
<p>ここでは全ての権限与えておりますが、実際に使う場合はActionやConditionブロックで制限したほうがよいかと思います。</p>
<h2 id="フォーム">フォーム</h2>
<p>続いてフォーム。<br>
<code>multipart/form-data</code>で、アップロードするファイルの属性や認証情報をPOSTします。<br>
各パラメータについては<a href="https://docs.aws.amazon.com/AmazonS3/latest/API/sigv4-HTTPPOSTForms.html%22">リファレンス</a>の[HTML Form Fields]をご参考。</p>
<pre><code class="language-html">&lt;form action=&quot;http://&lt;bucket name&gt;.s3.amazonaws.com/&quot; method=&quot;post&quot; enctype=&quot;multipart/form-data&quot;&gt;
  &lt;label&gt;
    S3 Tags for File: &lt;input type=&quot;text&quot;  name=&quot;x-amz-meta-tag&quot; value=&quot;&quot; /&gt;&lt;br /&gt;
  &lt;/label&gt;
  &lt;label&gt;
    Content-Type: &lt;span&gt;image/png&lt;/span&gt;
  &lt;/label&gt;

  &lt;!-- AWSが${filename}に選択したファイル名を入れてくれる --&gt;
  &lt;input type=&quot;hidden&quot; name=&quot;key&quot; value=&quot;from-form${filename}&quot; /&gt;
  &lt;input type=&quot;hidden&quot; name=&quot;acl&quot; value=&quot;private&quot; /&gt;
  &lt;input type=&quot;hidden&quot; name=&quot;success_action_redirect&quot; value=&quot;[任意のURL]&quot; /&gt;
  &lt;input type=&quot;hidden&quot; name=&quot;x-amz-server-side-encryption&quot; value=&quot;AES256&quot; /&gt;
  &lt;input type=&quot;hidden&quot; name=&quot;Policy&quot; value='[POST PlolicyをBase64エンコードした値]' /&gt;
  &lt;input type=&quot;hidden&quot; name=&quot;X-Amz-Signature&quot; value=&quot;[Policyをもとに作成したSignature]&quot; /&gt;
  &lt;input type=&quot;hidden&quot; name=&quot;X-Amz-Credential&quot; value=&quot;/20180219/ap-northeast-1/s3/aws4_request&quot; /&gt;
  &lt;input type=&quot;hidden&quot; name=&quot;X-Amz-Algorithm&quot; value=&quot;AWS4-HMAC-SHA256&quot; /&gt;
  &lt;input type=&quot;hidden&quot; name=&quot;X-Amz-Date&quot; value=&quot;20180219T000000Z&quot; /&gt;
  &lt;input type=&quot;hidden&quot; name=&quot;Content-Type&quot; value=&quot;image/png&quot; /&gt;
  &lt;label&gt;
    File: &lt;input type=&quot;file&quot; name=&quot;file&quot; /&gt; &lt;br /&gt;
  &lt;/label&gt;

  &lt;!-- The elements after this will be ignored --&gt;
  &lt;!-- submitより後にinput要素を置いても送信できないので、submitは一番最後に書く。 --&gt;
  &lt;input type=&quot;submit&quot; name=&quot;submit&quot; value=&quot;Upload to Amazon S3&quot; /&gt;
&lt;/form&gt;
</code></pre>
<p>試していて、次のようなところで手間取りました。<br>
ただの私の確認不足なのですが……</p>
<h3 id="signature生成">Signature生成</h3>
<p>POST PolicyをBase64エンコードしたものをPolicyというFieldに指定。<br>
それをStringToSignとして、認証情報（Signature）を生成しFieldにのせます。</p>
<p><a href="https://docs.aws.amazon.com/ja_jp/general/latest/gr/sigv4-signed-request-examples.html">生成手順</a>を参考にPHPで実装したのですが、各処理ステップでキー文字列を16進数文字列に変換してしまい、上手く認証が通らず？になってました。<br>
正しくは、キーをバイナリデータとしてそのまま渡せばOK。１６進数文字列にするのは生成したSignatureをFormのフィールドに指定する時だけ。</p>
<pre><code class="language-php">function makeSignatureKey($awsSecretKey, $dateStamp, $regionName, $serviceName) {
  // 間違い
  //    $kDate = bin2hex(signHash('AWS4' . $awsSecretKey, $dateStamp));
  //    $kRegion = bin2hex(signHash($kDate, $regionName));
  //    $kService = bin2hex(signHash($kRegion, $serviceName));
  //    $kSign = bin2hex(signHash($kService, 'aws4_request'));

  $kDate = signHash('AWS4' . $awsSecretKey, $dateStamp);
  $kRegion = signHash($kDate, $regionName);
  $kService = signHash($kRegion, $serviceName);
  $kSign = signHash($kService, 'aws4_request');
  return $kSign;
}
</code></pre>
<h3 id="fieldの位置">Fieldの位置</h3>
<p>各フィールド、POST Policyも大丈夫そうなのに、[key]フィールドが不足というエラーが発生。<br>
原因は、コードをととえている時にsubmitの位置を上にしてしまい、それ以降に書いているパラメータを送れていないからでした。</p>
<pre><code class="language-html">&lt;form action=&quot;http://&lt;bucket name&gt;.s3.amazonaws.com/&quot; method=&quot;post&quot; enctype=&quot;multipart/form-data&quot;&gt;
  &lt;!-- The elements after this will be ignored --&gt;
  &lt;input type=&quot;submit&quot; name=&quot;submit&quot; value=&quot;Upload to Amazon S3&quot; /&gt;

  &lt;!-- submit以降のフィールドが無視されるため、パラメータ不足エラーとなる。 --&gt;

  &lt;label&gt;
    S3 Tags for File: &lt;input type=&quot;text&quot;  name=&quot;x-amz-meta-tag&quot; value=&quot;&quot; /&gt;&lt;br /&gt;
  &lt;/label&gt;
  &lt;label&gt;
    Content-Type: &lt;span&gt;image/png&lt;/span&gt;
  &lt;/label&gt;
  &lt;input type=&quot;hidden&quot; name=&quot;key&quot; value=&quot;from-form${filename}&quot; /&gt;
  ...
&lt;/form&gt;
</code></pre>
<p><a href="https://docs.aws.amazon.com/AmazonS3/latest/API/sigv4-HTTPPOSTForms.html">リファレンス</a>を見なおすと、<code>&lt;!-- The elements after this will be ignored --&gt;</code>とちゃんと書いてありますね。恥ずかしい。</p>
<p>サンプルコードは<a href="https://github.com/takakd/demo-page/tree/master/docs/s3post">こちら</a></p>
<p>単純なPOSTだとPOST Policyのフォームが楽そうですが、少し込み入った処理（容量が大きいファイル送信など）をする場合は、JavaScriptのSDKを使ったほうがよさそうです。<br>
また試してみよう。</p>

        
      </div>
      
    </div>
  </section>
  


<section class="ft-Section mt-auto ml-0 mr-0 mb-0 pa-0">
  <div class="d-flex px-5 py-lg-3 pt-4 pb-3 align-items-center justify-content-md-between align-items-md-center flex-lg-row flex-column">
    <div class="d-flex align-items-center"><a class="ml-4 cs-sns-icon-link" aria-label="facebook"
        href='https://facebook.com/takakd987' target='_blank' rel='noopener'><?xml version="1.0" encoding="UTF-8" standalone="no"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg width="100%" height="100%" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" xmlns:serif="http://www.serif.com/" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;"><g><path d="M1024,512c0,-282.77 -229.23,-512 -512,-512c-282.77,0 -512,229.23 -512,512c0,255.554 187.231,467.37 432,505.78l0,-357.78l-130,0l0,-148l130,0l0,-112.8c0,-128.32 76.438,-199.2 193.39,-199.2c56.017,0 114.61,10 114.61,10l0,126l-64.562,0c-63.603,0 -83.438,39.467 -83.438,79.957l0,96.043l142,0l-22.7,148l-119.3,0l0,357.78c244.769,-38.41 432,-250.226 432,-505.78Z" style="fill:#fff;fill-rule:nonzero;"/></g></svg></a><a class="ml-4 cs-sns-icon-link" aria-label="github"
        href='https://github.com/takakd' target='_blank' rel='noopener'><?xml version="1.0" encoding="UTF-8" standalone="no"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg width="100%" height="100%" viewBox="0 0 33 32" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" xmlns:serif="http://www.serif.com/" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;"><path d="M16.288,0.015c-8.994,0 -16.288,7.293 -16.288,16.29c0,7.197 4.667,13.302 11.14,15.456c0.815,0.15 1.112,-0.353 1.112,-0.785c0,-0.387 -0.014,-1.411 -0.022,-2.77c-4.531,0.984 -5.487,-2.184 -5.487,-2.184c-0.741,-1.882 -1.809,-2.383 -1.809,-2.383c-1.479,-1.01 0.112,-0.99 0.112,-0.99c1.635,0.115 2.495,1.679 2.495,1.679c1.453,2.489 3.813,1.77 4.741,1.353c0.148,-1.052 0.569,-1.77 1.034,-2.177c-3.617,-0.411 -7.42,-1.809 -7.42,-8.051c0,-1.778 0.635,-3.233 1.677,-4.371c-0.168,-0.412 -0.727,-2.069 0.16,-4.311c0,0 1.367,-0.438 4.479,1.67c1.299,-0.362 2.693,-0.542 4.078,-0.549c1.384,0.007 2.777,0.187 4.078,0.549c3.11,-2.108 4.475,-1.67 4.475,-1.67c0.889,2.242 0.33,3.899 0.163,4.311c1.044,1.138 1.674,2.593 1.674,4.371c0,6.258 -3.809,7.635 -7.437,8.038c0.584,0.503 1.105,1.497 1.105,3.016c0,2.178 -0.02,3.935 -0.02,4.469c0,0.436 0.294,0.943 1.12,0.784c6.468,-2.159 11.131,-8.26 11.131,-15.455c0,-8.997 -7.294,-16.29 -16.291,-16.29Z" style="fill:#fff;"/></svg></a><a class="ml-4 cs-sns-icon-link" aria-label="linkedin"
        href='https://linkedin.com/in/takakd' target='_blank' rel='noopener'><svg id="Group_1282" data-name="Group 1282" xmlns="http://www.w3.org/2000/svg" width="76.624" height="65.326" viewBox="0 0 76.624 65.326">
  <path id="Path_2525" data-name="Path 2525" d="M1165,274.515a1.2,1.2,0,0,0,1.21-1.269c0-.9-.543-1.33-1.657-1.33h-1.8v4.712h.677v-2.054h.832l.019.025,1.291,2.029h.724l-1.389-2.1Zm-.783-.472h-.785V272.45h.995c.514,0,1.1.084,1.1.757,0,.774-.593.836-1.314.836" transform="translate(-1092.136 -213.406)" fill="#0a66c2"/>
  <path id="Path_2520" data-name="Path 2520" d="M958.98,112.559h-9.6V97.525c0-3.585-.064-8.2-4.993-8.2-5,0-5.765,3.906-5.765,7.939v15.294h-9.6V81.642h9.216v4.225h.129a10.1,10.1,0,0,1,9.093-4.994c9.73,0,11.524,6.4,11.524,14.726ZM918.19,77.416a5.571,5.571,0,1,1,5.57-5.572,5.571,5.571,0,0,1-5.57,5.572m4.8,35.143h-9.61V81.642h9.61Zm40.776-55.2h-55.21a4.728,4.728,0,0,0-4.781,4.67v55.439a4.731,4.731,0,0,0,4.781,4.675h55.21a4.741,4.741,0,0,0,4.8-4.675V62.025a4.738,4.738,0,0,0-4.8-4.67" transform="translate(-903.776 -57.355)" fill="#0a66c2"/>
  <path id="Path_2526" data-name="Path 2526" d="M1156.525,264.22a4.418,4.418,0,1,0,.085,0h-.085m0,8.33a3.874,3.874,0,1,1,3.809-3.938c0,.022,0,.043,0,.065a3.791,3.791,0,0,1-3.708,3.871h-.1" transform="translate(-1084.362 -207.809)" fill="#0a66c2"/>
</svg>
</a><a class="ml-4 cs-sns-icon-link" aria-label="twitter"
        href='https://twitter.com/takakdkd' target='_blank' rel='noopener'><?xml version="1.0" encoding="utf-8"?>
<!-- Generator: Adobe Illustrator 20.0.0, SVG Export Plug-In . SVG Version: 6.00 Build 0)  -->
<svg version="1.1" id="White" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
	 viewBox="0 0 400 400" style="enable-background:new 0 0 400 400;" xml:space="preserve">
<style type="text/css">
	.st0{fill:#FFFFFF;}
</style>
<path class="st0" d="M400,200c0,110.5-89.5,200-200,200S0,310.5,0,200S89.5,0,200,0S400,89.5,400,200z M163.4,305.5
	c88.7,0,137.2-73.5,137.2-137.2c0-2.1,0-4.2-0.1-6.2c9.4-6.8,17.6-15.3,24.1-25c-8.6,3.8-17.9,6.4-27.7,7.6
	c10-6,17.6-15.4,21.2-26.7c-9.3,5.5-19.6,9.5-30.6,11.7c-8.8-9.4-21.3-15.2-35.2-15.2c-26.6,0-48.2,21.6-48.2,48.2
	c0,3.8,0.4,7.5,1.3,11c-40.1-2-75.6-21.2-99.4-50.4c-4.1,7.1-6.5,15.4-6.5,24.2c0,16.7,8.5,31.5,21.5,40.1c-7.9-0.2-15.3-2.4-21.8-6
	c0,0.2,0,0.4,0,0.6c0,23.4,16.6,42.8,38.7,47.3c-4,1.1-8.3,1.7-12.7,1.7c-3.1,0-6.1-0.3-9.1-0.9c6.1,19.2,23.9,33.1,45,33.5
	c-16.5,12.9-37.3,20.6-59.9,20.6c-3.9,0-7.7-0.2-11.5-0.7C110.8,297.5,136.2,305.5,163.4,305.5"/>
</svg>
</a></div>
    <div>
      <p class="ml-0 mr-0 mb-0 mt-3 mt-lg-0 p-0 cs-copyright">&copy; taka 2018</p>
      
    </div>
  </div>
</section>






<script src="/assets/bundle.min.js"></script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-108607644-3', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>




</body>

</html>